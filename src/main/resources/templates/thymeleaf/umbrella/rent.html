<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml"  >
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <scrpit th:src="@{../static/js/umbrella.js}"></scrpit>
    <link th:href="@{../htmlTemplates/css/rent.css}" rel="stylesheet" href="../../../static/htmlTemplates/css/rent.css">
    <title>USAN</title>

</head>
<body>
<div class="container_lent">
    <div class="lent">
        <h1>대여하기</h1>
        <h3>사용자 ID : 두근두근</h3>
    </div>
    <form class="lent_form">
        <div class="lent_choice">

            <div class="lent_location">
                <label for="location">보관소 위치 선택</label>
                <select id="location">
                    <option id="ptu" value="평택대" selected >평택대</option>
                    <option id="psb" value="평택역">평택역</option>
                </select>
            </div>

            <div id="lent_condition">
            </div>
            <div class="lent_date">
                <label>대여기간 선택</label>
                <input id="days" type="number" min="1" max="30" value="1">일
            </div>
            <p id="lent_date_result"></p>
        </div>
        <div class="lent_btn">
            <button type="button" class="btn_submit" onclick="instance.test()">대여하기</button>
            <button type="reset" class="btn_reset">취소하기</button>
        </div>
    </form>

</div>


</body>

<script>
    let instance={
        test:function(){
            const days = document.getElementById('days').value
            const locations = document.getElementById('location').value
            if (confirm(locations+"지점에서 "+days+"일 동안 대여하시겠습니까?")) {
                let data={
                    locations:locations,
                    days:days
                };
                $.ajax({
                    type: "POST",
                    url:`/umb/rent/${locations}/${days}`,
                    data: JSON.stringify(data), // http body 데이터
                    contentType: "application/json; charset=utf-8", // body데이터가 어떤 타입인지(MIME)
                    async:false,
                    dataType: "json" // 요청을 서버로해서 응답이 왔을때 기본적으로 모든것이 문자열로오는데
                    // 생긴게 json이라면 => javascript 오브젝트로 변경 해줌
                }).done(function (resp) {
                    if (resp.status === 500) {
                        alert("우산 등록이 실패하였습니다 \n아이디가 중복되었습니다.");
                    }else if (resp.response === 3) {
                        alert("우산이 꽉 찼습니다 반납후 이용해주세요");
                    } else  {
                        alert("우산 등록이 완료되었습니다.");
                        // console.log(resp)
                        location.href="/payment/edit";
                    }
                }).fail(function (error) {
                    alert(" Error ->"+JSON.stringify(error));
                });

            } else {
            }


            }


    }
</script>

<script th:inline="javascript">

    let storage= [[${storages}]]
    let rent_location = document.getElementById("location");
    let rent_location_select = rent_location.options[rent_location.selectedIndex].innerText;


    // let result_rent_location =  document.getElementById("lent_condition").innerHTML=`현재 ${rent_location_select}의 우산 잔여 갯수는 0개 입니다.`

    const b = document.getElementById('location')


    document.getElementById("lent_condition").innerHTML = `☂️: ${storage[rent_location.selectedIndex].umb_count}개`;

    b.addEventListener('change',changeLocation)
    function changeLocation() {
        rent_location = document.getElementById("location");
        rent_location_select = rent_location.options[rent_location.selectedIndex].innerText;
        alert(storage[rent_location.selectedIndex].umb_count)
        if (storage[rent_location.selectedIndex].umb_count === 0) {
            let a =document.getElementById("lent_condition").innerHTML = `☂️: ${storage[rent_location.selectedIndex].umb_count}개`;
            document.getElementById("lent_condition").style.color="#FF0000";
        } else {
            document.getElementById("lent_condition").innerHTML = `☂️: ${storage[rent_location.selectedIndex].umb_count}개`;
            document.getElementById("lent_condition").style.color="#000000";
        }


        console.log( document.getElementById("location").options[document.getElementById("location").selectedIndex]);
    }

    var price = document.getElementById('days').value * 700; //맨 처음 선언 해주는 700원의 값 설정


    let a = document.getElementById('days')
    document.getElementById("lent_date_result").innerHTML=`대여비용은 ${price}원입니다.` //초기 값
    a.addEventListener('input', rental)


    function rental() {
        console.log(document.getElementById('days').value * 700);
        price = document.getElementById('days').value * 700
        document.getElementById("lent_date_result").innerHTML=`대여비용은 ${price}원입니다.` //변해주는값
    }
</script>
</html>